<!doctype html>
<html class="no-js" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
     ObjC、C、C++混编 - TIME TO GO 
  </title>
   
  <link href="atom.xml" rel="alternate" title="TIME TO GO" type="application/atom+xml">
  <link rel="stylesheet" href="asset/css/foundation.min.css" />
  <link rel="stylesheet" href="asset/css/docs.css" />
  <script src="asset/js/vendor/modernizr.js"></script>
  <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
  <script type="text/javascript">
    function before_search() {
      var searchVal = 'site: ' + document.getElementById('search_input').value;
      document.getElementById('search_q').value = searchVal;
      return true;
    }
  </script>
</head>

<body class="antialiased hide-extras">
  <div class="marketing off-canvas-wrap" data-offcanvas>
    <div class="inner-wrap">


      <nav class="top-bar docs-bar hide-for-small" data-topbar>
        <section class="top-bar-section">
          <div class="row">
            <div style="position: relative;width:100%;">
              <div style="position: absolute; width:100%;">
                <ul id="main-menu" class="left">
                  
                  <li id="">
                    <a target="self" href="index.html">Home</a>
                  </li>
                  
                  <li id="">
                    <a target="_self" href="archives.html">Archives</a>
                  </li>
                  
                </ul>
                <ul class="right" id="search-wrap">
                  <li>
                    <form target="_blank" onsubmit="return before_search();" action="http://google.com/search" method="get">
                      <input type="hidden" id="search_q" name="q" value="" />
                      <input tabindex="1" type="search" id="search_input" placeholder="Search" />
                    </form>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </section>
      </nav>

      <nav class="tab-bar show-for-small">
        <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
          <span> &nbsp; TIME TO GO</span>
        </a>
      </nav>

      <aside class="left-off-canvas-menu">
        <ul class="off-canvas-list">
          <li>
            <a href="index.html">HOME</a>
          </li>
          <li>
            <a href="archives.html">Archives</a>
          </li>
          <li>
            <a href="about.html">ABOUT</a>
          </li>
          <li>
            <label>Categories</label>
          </li>
          
        </ul>
      </aside>
      <a class="exit-off-canvas" href="#"></a>
      <section id="main-content" role="main" class="scroll-container"> <script type="text/javascript">
  $(function () {
    $('#menu_item_index').addClass('is_active');
    $('#sidebar').parent().parent().hide();
  });
</script>

<div class="row">
  <div class="large-12 medium-12 columns">
    <div class="markdown-body article-wrap">

      <div class="article">
        
        <h1>ObjC、C、C++混编</h1>
        <div class="read-more clearfix">
          <span class="date">2018/3/7</span>
           
          <span class="comments">
             
          </span>
        </div>
      </div>

      <div class="article-content">
        <ul>
<li>
<a href="#toc_0">一、文件类型</a>
</li>
<li>
<a href="#toc_1">二、头文件导入类型兼容判断</a>
</li>
<li>
<a href="#toc_2">三、修改编译模式的方式</a>
</li>
<li>
<a href="#toc_3">四、代码互相调用</a>
</li>
<li>
<a href="#toc_4">五、对象管理</a>
</li>
<li>
<a href="#toc_5">六、ObjC、C++代码混编案例</a>
</li>
<li>
<a href="#toc_6">七、补充</a>
</li>
</ul>


<h4 id="toc_0">一、文件类型</h4>

<ul>
<li>C类型

<ul>
<li>.h头文件：可以兼容C代码</li>
<li>.c源文件：可以兼容C代码</li>
</ul></li>
<li>C++类型

<ul>
<li>.hpp头文件：可以兼容C、C++代码</li>
<li>.cpp源文件：可以兼容C、C++代码</li>
</ul></li>
<li>Objective-C类型

<ul>
<li>.h头文件：可以兼容ObjC、C代码</li>
<li>.m源文件：可以兼容ObjC、C代码</li>
</ul></li>
<li>Objective-C++类型

<ul>
<li>.h头文件：可以兼容ObjC、C、C++代码</li>
<li>.mm源文件：可以兼容ObjC、C、C++代码</li>
</ul></li>
<li>补充

<ul>
<li>C++的.hpp头文件的内部一般写C++类、类的变量、类的方法的申明，而.cpp源文件内则写在.hpp头文件中申明的方法的实现；</li>
<li><strong>Xcode默认根据<code>文件类型（According to File Type）</code>，来选择编译模式；</strong></li>
<li><strong>若需要使用一些C++的标准库，需要导入libc++库；Xcode10和iOS12中已移除废弃多年的libstdc++库，由libc++库（llvm优化过，并全面支持C++11）代替；</strong></li>
</ul></li>
</ul>

<span id="more"></span><!-- more -->  

<h4 id="toc_1">二、头文件导入类型兼容判断</h4>

<ul>
<li><strong>当导入头文件时，需要判断<code>当前文件的代码类型</code>是否兼容<code>要导入头文件中的代码类型（包含其引入的库、导入的头文件）</code>；</strong></li>
<li><strong>若当前文件是头文件，头文件进行判断，若当前文件是源文件，源文件进行判断；</strong></li>
<li><strong>一般建议将要导入头文件，导入到源文件中，因为相关头文件，常常还需要导入到其他文件中使用；</strong></li>
<li><strong>比如Objective-C++类型的头文件A.h，导入到Objective-C++类型的头文件B.h，之后其他文件还需要导入B.h，就需要其他文件可以兼容头文件B.h中的代码类型（包含其引入的库、导入的头文件）；若导入的源文件B.mm中，而头文件B.h没有其他混合的代码，其他文件只需要兼容B.h中的代码类型即可；</strong></li>
</ul>

<h4 id="toc_2">三、修改编译模式的方式</h4>

<ul>
<li>1、将.m后缀修改为.mm后缀；</li>
<li>2、.m源文件修改右侧边栏的编译类型；</li>
<li>3、修改工程的编译类型为Objective-C++（Build Setting -&gt; Compile Sources As修改为Objective-C++）；</li>
</ul>

<h4 id="toc_3">四、代码互相调用</h4>

<ul>
<li>1、ObjC代码调用C代码

<ul>
<li>Objective-C的.m文件对C完全兼容；导入<code>所需要的头文件</code>后，就可以直接调用；</li>
</ul></li>
<li>2、C代码调用ObjC代码

<ul>
<li><strong>因为要调用ObjC代码，所以C代码需要编写在可以兼容ObjC代码类型的文件中，比如.m源文件、.mm源文件；</strong></li>
<li>之后导入<code>所需要的头文件</code>，就可以调用；</li>
<li><strong>若C代码不能写在兼容ObjC代码类型的文件中，可以创建一个<code>中间兼容代码类型文件（其头文件只有C代码，源文件内调用ObjC代码）</code>，之后C代码通过调用<code>中间文件</code>间接调用ObjC代码；</strong></li>
</ul></li>
<li>3、ObjC代码调用C++代码

<ul>
<li>选择【修改编译模式的方式】中的任意一种方式进行修改；</li>
<li>之后导入<code>所需要的头文件</code>，就可以调用；<strong>注意”头文件导入类型兼容判断“；</strong></li>
</ul></li>
<li>4、C++代码调用ObjC代码

<ul>
<li><strong>因为要调用ObjC代码，所以C++代码需要编写在可以兼容ObjC代码类型的文件中，比如.mm源文件；</strong></li>
<li>之后导入<code>所需要的头文件</code>，就可以调用；</li>
<li><strong>若C++代码不能写在兼容ObjC代码类型的文件中，可以创建一个<code>中间兼容代码类型文件（其头文件只有C、C++代码，源文件内调用ObjC代码）</code>，之后C++代码通过调用<code>中间文件</code>间接调用ObjC代码；</strong>比如在Cocos2d-X中，C++代码调用ObjC代码；</li>
</ul></li>
</ul>

<h4 id="toc_4">五、对象管理</h4>

<ul>
<li><strong>若需要在不同类型的代码中传递、持有对象数据，可以使用<code>void *</code>、<code>id</code>类型；C代码可以使用<code>void *</code>，ObjC、C++可以使用<code>void *</code>、<code>id</code>；并且要注意内存管理</strong></li>
<li>由Core Foundation创建、管理的对象，需要通过手动调用CFRetain、CFRelease来管理内存，有三个原则：

<ul>
<li>a. 通过Create、Copy方法得到的对象是有所有权的；</li>
<li>b. 通过Get方法得到的对象是没有所有权的；若想要处理，必须使用CFRetain添加自己为所有者；</li>
<li>c. 若有一个对象的所有权，在使用完成之后必须使用CFRelease进行释放；</li>
</ul></li>
<li><strong>对象转换修饰符</strong>

<ul>
<li>a. <code>__bridge</code>

<ul>
<li>用于将CF对象转换为OC对象，或者OC对象转换为CF对象，但不会对对象的Retain Count、所有权产生任何影响；</li>
<li>其只是为了让编译通过；</li>
</ul></li>
<li>b. <code>__bridge_transfer</code>

<ul>
<li>用于将CF对象转换为OC对象，不需要手动调用CFRelease（所有权转移给ARC）；</li>
<li>等价于CFBridgingRelease()；</li>
</ul></li>
<li>c. <code>__bridge_retained</code>

<ul>
<li>用于将OC对象转换为CF对象，之后需要手动调用CFRelease；</li>
<li>等价于CFBridgingRetain()；</li>
</ul></li>
</ul></li>
</ul>

<h4 id="toc_5">六、ObjC、C++代码混编案例</h4>

<ul>
<li><p>1、C++代码调用ObjC代码</p>

<pre><code class="language-objectivec">// Obj6.h
#import &lt;Foundation/Foundation.h&gt;

@interface Obj6 : NSObject
- (void)objC6_test1;
@end
</code></pre>

<pre><code class="language-objectivec">// Obj6.m
#import &quot;Obj6.h&quot;

@implementation Obj6
- (void)objC6_test1 {
    NSLog(@&quot;%s&quot;, __func__);
}

- (void)dealloc {
    NSLog(@&quot;%s&quot;, __func__);
}
@end
</code></pre>

<pre><code class="language-cpp">// CPlusCplus5.hpp
#ifndef CPlusCplus5_hpp
#define CPlusCplus5_hpp

#include &lt;stdio.h&gt;
#include &lt;iostream&gt;

class CPlusPlus5 {
public:
    CPlusPlus5();

    id _a;
    void *_b;
    void cPlusPlus5_test1();
    void cPlusPlus5_test2();
};

#endif /* CPlusCplus5_hpp */
</code></pre>

<pre><code class="language-text">// CPlusCplus5.mm
#include &quot;CPlusCplus5.hpp&quot;
#import &quot;Obj6.h&quot;

using namespace std;

CPlusPlus5::CPlusPlus5() {
    _a =  [[Obj6 alloc] init];

    Obj6 *objc6 = [[Obj6 alloc] init];
    _b = (__bridge_retained void *)objc6;
}

void CPlusPlus5::cPlusPlus5_test1() {
    cout &lt;&lt; __func__ &lt;&lt; endl;

    Obj6 *objc6 = [[Obj6 alloc] init];
    [objc6 objC6_test1];
}

void CPlusPlus5::cPlusPlus5_test2() {
    cout &lt;&lt; __func__ &lt;&lt; endl;

    [_a objC6_test1];

    cout &lt;&lt; &quot;---------&quot; &lt;&lt; endl;
    [(__bridge_transfer Obj6 *)_b objC6_test1];
}
</code></pre></li>
<li><p>2、ObjC代码调用C++代码</p>

<pre><code class="language-text">ObjC7.h
#import &lt;Foundation/Foundation.h&gt;

@interface ObjC7 : NSObject
- (void)objC7_test1;
@end
</code></pre>

<pre><code class="language-text">// ObjC7.mm
#import &quot;ObjC7.h&quot;
#import &quot;CPlusCplus5.hpp&quot;

@implementation ObjC7
- (void)objC7_test1 {
    NSLog(@&quot;%s&quot;, __func__);

    CPlusPlus5 cPlus;
//    cPlus.cPlusPlus5_test1();
    cPlus.cPlusPlus5_test2();
}
@end
</code></pre></li>
</ul>

<h4 id="toc_6">七、补充</h4>

<ul>
<li>1、stdio、iostream

<ul>
<li>stdio库属于c语言，输出、输入使用printf()、scanf()；</li>
<li>iostream库属于c++语言，输出、输入使用count&lt;&lt; ...、cin &gt;&gt; ...；</li>
<li>编写C++代码可以同时使用stdio库和iostream库，但是推荐使用iostream库；</li>
</ul></li>
<li><p>2、namespace</p>

<ul>
<li>新的标准C++为了避免名字定义冲突，引入了命名空间namespace；为了正确使用命名空间，也为了和C区分开来，规定头文件不使用后缀.h；</li>
<li><code>#include &lt;iostream.h&gt;</code>

<ul>
<li>在旧的C++标准中使用；</li>
<li>不能引入命名空间，否则会编译出错；</li>
<li>输出可直接使用cout&lt;&lt; x;</li>
</ul></li>
<li><p><code>#include &lt;iostream&gt;</code></p>

<ul>
<li>在新的C++标准中使用；</li>
<li>必须引入命名空间，否则会编译出错；</li>
<li><p>三种使用方式：</p>

<pre><code class="language-cpp">std::cout &lt;&lt; x;
</code></pre>

<pre><code class="language-cpp">using namespace std;
cout &lt;&lt; x;
</code></pre>

<pre><code class="language-cpp">using std::cout;
cout &lt;&lt; x;
</code></pre></li>
</ul></li>
<li><p><code>#include&quot;iostream&quot;</code></p>

<ul>
<li>先从自定义的文件中寻找，若找不到再从编译器自带的函数库中寻找；</li>
</ul></li>
<li><p><strong>头文件有&quot;.h&quot;的是C的标准库、旧的C++的标准；头文件无&quot;.h&quot;的是新的C++的标准，需要用到命令空间；</strong></p></li>
</ul></li>
</ul>

      </div>

      <div class="row">
        <div class="large-6 columns">
          <p class="text-left" style="padding:15px 0px;">
            
            <a href="15206830265209.html" title="Previous Post: Swift、ObjC混编">&laquo; Swift、ObjC混编</a>
            
          </p>
        </div>
        <div class="large-6 columns">
          <p class="text-right" style="padding:15px 0px;">
            
            <a href="15147939316129.html" title="Next Post: Carthage配置使用">Carthage配置使用 &raquo;</a>
            
          </p>
        </div>
      </div>

      <div class="comments-wrap">
        <div class="share-comments">
            
        </div>
      </div>

    </div>
  </div> <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">

      <div id="site-info" class="site-info">
        
        <h1>TIME TO GO</h1>
        <div class="site-des">It is just a matter of time.</div>
        <div class="social">
                    
          <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
        </div>
      </div>

      

      <div id="site-categories" class="side-item ">
        <div class="side-header">
          <h2>Categories</h2>
        </div>
        <div class="side-content">
          <p class="cat-list">
            
          </p>
        </div>
      </div>

      <div id="site-categories" class="side-item">
        <div class="side-header">
          <h2>Recent Posts</h2>
        </div>
        <div class="side-content">
          <ul class="posts-list">
              <li class="post">
              <a href="16204916511807.html">iOS 13暗黑模式适配</a>
              </li>
                 <li class="post">
              <a href="15859991604863.html">多线程与GCD</a>
              </li>
                 <li class="post">
              <a href="15705573115081.html">iOS、macOS应用启动逻辑</a>
              </li>
                 <li class="post">
              <a href="15703760378326.html">NIB、XIB、StoryBoard与UIViewController、UIView</a>
              </li>
                 <li class="post">
              <a href="15626010144789.html">iOS状态栏</a>
              </li>
                                             
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>

</div> <div class="page-bottom clearfix">
  <div class="row">
    <p class="copyright">Copyright &copy; 2015 Powered by
      <a target="_blank" href="">ME</a>
    </p>
  </div>
</div>
</section>

</div>
</div>

 
<script src="asset/js/foundation.min.js"></script>
<script>
  $(document).foundation();
  function fixSidebarHeight() {
    var w1 = $('.markdown-body').height();
    var w2 = $('#sidebar').height();
    if (w1 > w2) { $('#sidebar').height(w1); };
  }
  $(function () {
    fixSidebarHeight();
  })
  $(window).load(function () {
    fixSidebarHeight();
  });
</script>   
</body>

</html>